<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<title>fiug (new)</title>
	<meta name="description" content="">
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<meta name="theme-color" content="#1e1e1e">
	<meta name="light-page-color" content="white">
	<meta name="light-theme-color" content="#227a9c">
	<meta name="dark-page-color" content="#2d2d2d">
	<meta name="dark-theme-color" content="#1e1e1e">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	
	<link rel="stylesheet" href="index.css">
	<link rel="stylesheet" href="https://cdn.skypack.dev/golden-layout@2.4.0/dist/css/goldenlayout-base.css">
	<link rel="stylesheet" href="https://cdn.skypack.dev/golden-layout@2.4.0/dist/css/themes/goldenlayout-dark-theme.css">
</head>

<style>
:root {
	--status-bg: teal;
}
@media (prefers-color-scheme: dark) {
	html { background: #111; }
}

html, body{
	height: 100%;
	margin: 0;
	display: flex;
	flex-direction:column;
	height: 100%
}

body:after {
	display: block;
	content: '';
	position: absolute;
	background: var(--status-bg);
	bottom: 0;
	left: 0;
	height: 22px;
	right: 0;
	z-index: -1;
}
/*
.lm_item {
	z-index:3;
}
*/

#layoutContainer {
	flex: 1 1 auto;
	height: 100%;
}

.lm_goldenlayout {
	background: transparent !important;
}
.lm_content {
	background: none !important;
	border: 0 !important;
}
.lm_transition_indicator {
	background-color: #3333 !important;
	border: 0 !important;
}
.lm_dropTargetIndicator {
	outline: 0 !important;
	box-shadow: none !important;
	background: #6668;
}


/*
.lm_header .lm_tab, .lm_header {
	height: 40px !important;
}
.lm_splitter {
	background: transparent !important;
}
.lm_splitter.lm_horizontal {
	margin-left: -2.5px;
	margin-right: -2.5px;
}
.lm_splitter.lm_vertical {
	margin-top: -2.5px;
	margin-bottom: -2.5px;
}
.lm_splitter:hover .lm_drag_handle {
	background: #444444;
	z-index:0;
}
*/
</style>


<body>
	<div id="layoutContainer"></div>
</body>

<script>
	//import layout from 'https://unpkg.com/golden-layout@2.4.0/dist/esm/index.js'
	//console.log(layout)
	const darkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
	//console.log('Mode is: ' + (darkMode ? "dark" : "light"));
</script>

<script type="module">
	import * as gl from "https://cdn.skypack.dev/golden-layout@2.4.0";
	//console.log(Object.keys(gl))
	const { GoldenLayout } = gl;

	let savedLayout;
	try {
		savedLayout = JSON.parse(localStorage.getItem('layout'));
	}catch(e){}
	const layoutConfig = savedLayout || await fetch('index.layout.json').then(r => r.json());
	const layoutContainer = document.getElementById("layoutContainer");

	window.addEventListener('resize', () => {
		// handling of resize event is required if GoldenLayout does not use body element
		const width = document.body.offsetWidth;
		const height = document.body.offsetHeight;
		goldenLayout.setSize(width, height);
	});

	const iframeSandboxPermissions = [
		"allow-same-origin",
		"allow-scripts",
		"allow-popups",
		"allow-modals",
		"allow-downloads",
		"allow-forms",
		"allow-top-navigation",
		"allow-popups-to-escape-sandbox"
	].join(' ');
	const iframeUrls = {
		Tree: "./dist/tree.html",
		Editor: "./dist/editor.html",
		Terminal: "./dist/terminal.html",
	};

	class Tree {
		get rootHtmlElement() {
			return this._root;
		}
		constructor(container){
			this._root = document.createElement('div');
			const iframe = document.createElement('iframe');
			iframe.src = iframeUrls.Tree;
			iframe.style="height:100%;width:100%;border:0;";
			iframe.sandbox = iframeSandboxPermissions;
			this._root.append(iframe);
			this._root.classList.add('tree');
		}
	}
	class Editor {
		get rootHtmlElement() {
			return this._root;
		}
		constructor(container){
			this._root = document.createElement('div');
			const iframe = document.createElement('iframe');
			iframe.src = iframeUrls.Editor;
			iframe.style="height:100%;width:100%;border:0;";
			iframe.sandbox = iframeSandboxPermissions;
			this._root.append(iframe);
			this._root.classList.add('editor');
		}
	}
	class Terminal {
		get rootHtmlElement() {
			return this._root;
		}
		constructor(container){
			this._root = document.createElement('div');
			const iframe = document.createElement('iframe');
			iframe.src = iframeUrls.Terminal;
			iframe.style="height:100%;width:100%;border:0;";
			iframe.sandbox = iframeSandboxPermissions;
			this._root.append(iframe);
			this._root.classList.add('terminal');
		}
	}

	/*
	const componentInstances = []
	const createComponent = async (container, itemConfig) => {
		//console.log(itemConfig)

		const { componentType: type, componentState: props } = itemConfig;
		let iframeContainer;
		if(iframeUrls[type]){
			//const component = { type, props }
			//component.container = () => container;
			const rootEl = document.createElement('div')
			//component.rootElement = () => rootEl;
			rootEl.style.position = 'absolute';
			rootEl.style.overflow = 'hidden';
			
			const iframe = document.createElement('iframe');
			iframe.src = iframeUrls[type];
			iframe.style="height:100%;width:100%;border:0;";
			iframe.sandbox = iframeSandboxPermissions;
			rootEl.append(iframe);

			layoutContainer.querySelector('.lm_root').append(rootEl);

			const component = {
				type, props, element: rootEl
			};
			component.virtualRectingRequiredEvent = (container, width, height) => {
				console.log('virtualRectingRequiredEvent');
			};
			component.virtualVisibilityChangeRequiredEvent = (container, visible) => {
				console.log('virtualVisibilityChangeRequiredEvent');
			};

			componentInstances.push(component);
			return { component, virtual: true };
		}
		const component = {
			//id: ++this.instanceId,
			type,
			props,
			element: container.element,
		};

		//component.virtualRectingRequiredEvent = adaptComponent;
		componentInstances.push(component);
		return { component, virtual: false };
	};
	const destroyComponent = (container) => {
		console.log('destroyComponent')
	};*/

	const goldenLayout = new GoldenLayout(layoutContainer);
	goldenLayout.registerComponentConstructor('Tree', Tree, true);
	goldenLayout.registerComponentConstructor('Editor', Editor, true);
	goldenLayout.registerComponentConstructor('Terminal', Terminal, true);
	goldenLayout.loadLayout(layoutConfig);
	
	goldenLayout.on('stateChanged', function(){
		//console.log('stateChanged')
		//console.log(arguments)
		//TODO: consider debounce
		const state = JSON.stringify( goldenLayout.saveLayout() );
		localStorage.setItem('layout', state );
	});

	goldenLayout.on('itemCreated', function (item) {
		console.log('itemCreated')
		if (item?.config?.cssClass) {
			console.log('itemCreated cssClass')
			const classes = Array.isArray(item.config.cssClass)
				? item.config.cssClass
				: item.config.cssClass.split(' ');
			item.element.classList.add(...classes);
		}
	});

</script>

</html>
